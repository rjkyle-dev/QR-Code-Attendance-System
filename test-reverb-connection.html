<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Reverb Connection</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .status {
      padding: 20px;
      margin: 10px 0;
      border-radius: 8px;
      font-weight: bold;
    }

    .success {
      background: #d4edda;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
    }

    .info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .log {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
    }

    .log-entry {
      padding: 5px;
      border-bottom: 1px solid #eee;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      background: #007bff;
      color: white;
    }

    button:hover {
      background: #0056b3;
    }

    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <h1>üîç Laravel Reverb Connection Tester</h1>

  <div class="test-section">
    <h2>Step 1: Check Requirements</h2>
    <div id="requirements"></div>
  </div>

  <div class="test-section">
    <h2>Step 2: Test WebSocket Connection</h2>
    <button onclick="testConnection()">Test Connection</button>
    <button onclick="clearLogs()">Clear Logs</button>
    <div id="connection-status"></div>
  </div>

  <div class="test-section">
    <h2>Connection Logs</h2>
    <div class="log" id="logs"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/pusher-js@8.4.0-rc2/dist/web/pusher.min.js"></script>
  <script>
    const logs = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      logs.push({ message: logEntry, type });
      updateLogsUI();
      console.log(logEntry);
    }

    function updateLogsUI() {
      const logsDiv = document.getElementById('logs');
      logsDiv.innerHTML = logs.map(l =>
        `<div class="log-entry" style="color: ${l.type === 'error' ? '#dc3545' :
          l.type === 'success' ? '#28a745' :
            '#333'
        }">${l.message}</div>`
      ).join('');
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    function clearLogs() {
      logs.length = 0;
      updateLogsUI();
    }

    function checkRequirements() {
      const reqDiv = document.getElementById('requirements');
      let html = '';

      // Check if Pusher is loaded
      if (typeof Pusher !== 'undefined') {
        html += '<div class="status success">‚úÖ Pusher JS loaded</div>';
        log('Pusher JS is available', 'success');
      } else {
        html += '<div class="status error">‚ùå Pusher JS not loaded</div>';
        log('ERROR: Pusher JS not available', 'error');
      }

      // Check localStorage for debugging
      const reverbConfig = {
        host: '127.0.0.1',
        port: 8080,
        key: 'at0celvwhxzdyaycs5md', // From your .env
        scheme: 'ws'
      };

      html += `<div class="status info">
                ‚ÑπÔ∏è Configuration:<br>
                Host: ${reverbConfig.host}<br>
                Port: ${reverbConfig.port}<br>
                Key: ${reverbConfig.key}<br>
                Scheme: ${reverbConfig.scheme}
            </div>`;

      reqDiv.innerHTML = html;
    }

    function testConnection() {
      log('üöÄ Starting connection test...', 'info');
      const statusDiv = document.getElementById('connection-status');

      try {
        // Configuration from your .env
        const config = {
          wsHost: '127.0.0.1',
          wsPort: 8080,
          key: 'at0celvwhxzdyaycs5md',
          forceTLS: false,
          enabledTransports: ['ws'],
          disableStats: true,
          cluster: ''
        };

        log(`Connecting to ws://${config.wsHost}:${config.wsPort}...`, 'info');

        const pusher = new Pusher(config.key, config);

        // Connection events
        pusher.connection.bind('connecting', () => {
          log('üì° Connecting to Reverb...', 'info');
          statusDiv.innerHTML = '<div class="status info">üì° Connecting...</div>';
        });

        pusher.connection.bind('connected', () => {
          log('‚úÖ Connected successfully!', 'success');
          statusDiv.innerHTML = '<div class="status success">‚úÖ Connected to Reverb!</div>';

          // Subscribe to notifications channel
          log('Subscribing to "notifications" channel...', 'info');
          const channel = pusher.subscribe('notifications');

          channel.bind('pusher:subscription_succeeded', () => {
            log('‚úÖ Subscribed to notifications channel', 'success');
          });

          channel.bind('pusher:subscription_error', (error) => {
            log(`‚ùå Subscription error: ${JSON.stringify(error)}`, 'error');
          });

          // Listen for AbsenceRequested event
          channel.bind('AbsenceRequested', (data) => {
            log(`üéâ RECEIVED EVENT: ${JSON.stringify(data)}`, 'success');
            alert('Event received! Check logs.');
          });

          log('‚úÖ Listening for AbsenceRequested events...', 'success');
          log('‚ÑπÔ∏è Now submit an absence form to test!', 'info');
        });

        pusher.connection.bind('unavailable', () => {
          log('‚ùå Connection unavailable', 'error');
          statusDiv.innerHTML = '<div class="status error">‚ùå Cannot connect to Reverb</div>';
        });

        pusher.connection.bind('failed', () => {
          log('‚ùå Connection failed', 'error');
          statusDiv.innerHTML = '<div class="status error">‚ùå Connection Failed</div>';
        });

        pusher.connection.bind('disconnected', () => {
          log('‚ö†Ô∏è Disconnected from Reverb', 'error');
          statusDiv.innerHTML = '<div class="status error">‚ö†Ô∏è Disconnected</div>';
        });

        pusher.connection.bind('error', (err) => {
          log(`‚ùå Error: ${JSON.stringify(err)}`, 'error');
          statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${err.error?.data?.message || err.type}</div>`;
        });

        pusher.connection.bind('state_change', (states) => {
          log(`Connection state: ${states.previous} ‚Üí ${states.current}`, 'info');
        });

      } catch (error) {
        log(`‚ùå Exception: ${error.message}`, 'error');
        statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
      }
    }

    // Run checks on load
    window.addEventListener('load', () => {
      checkRequirements();
      log('Test page loaded. Click "Test Connection" to start.', 'info');
    });
  </script>
</body>

</html>